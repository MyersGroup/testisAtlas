---
title: "Gene Ontology Enrichment Analysis"
output: html_notebook
---

```{r}
library(SDAtools)
library(testisAtlas)

#load("../data/tmp_cache/cached_objects.rds")

results <- load_results(results_folder = "../data/SDA/conradV3_sda_1/", data_path = "../data/count_matrices/")
rownames(results$loadings[[1]]) <- paste0("V",1:50)
str(results)
```


```{r, fig.width=6}

library(AnnotationHub) # source("https://bioconductor.org/biocLite.R"); biocLite("AnnotationHub")
library(clusterProfiler) # source("https://bioconductor.org/biocLite.R"); biocLite("clusterProfiler")
library(AnnotationDbi)

# load GO database
hub <- AnnotationHub()
query(hub, "Musculus")
query(hub, "org.MM.eg")
Musculus <- hub[["AH66157"]] #AH57974, AH52234, AH57184
#AH57974 ncbi orgdb


# perform GO enrichment for each component (+ & - seperately)
GO_data <- list()

for (i in 1:50){
GO_data[[paste0("V",i,"N")]] <- GO_enrichment(i, side="N") 
GO_data[[paste0("V",i,"P")]] <- GO_enrichment(i, side="P")
}

# reduce size taken up
# lapply(names(GO_data), function(x) GO_data[[x]]@geneSets <<- list())

saveRDS(GO_data, "../data/GO_enrichment.rds")

# Convert to single data.table

for(i in names(GO_data)){
  GO_data[[i]]$Component <- i
}

GO_data_dt <- data.table(do.call("rbind", GO_data))

saveRDS(GO_data_dt, "../data/GO_enrichment_dt.rds")

# plot example result

go_volcano_plot(GO_data_dt, component = "V30P")
head(GO_data[["V30P"]][c(2,7,8,10)], 20)


```

