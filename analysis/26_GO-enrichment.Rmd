---
title: "Gene Ontology Enrichment Analysis"
output: html_notebook
---

```{r}
library(SDAtools)

results <- load_results(results_folder = "../data/SDA/conradV3_sda_1/", data_path = "../data/count_matrices/")
rownames(results$loadings[[1]]) <- paste0("V",1:50)
str(results)
```


```{r, fig.width=6}

library(AnnotationHub) # source("https://bioconductor.org/biocLite.R"); biocLite("AnnotationHub")
library(clusterProfiler) # source("https://bioconductor.org/biocLite.R"); biocLite("clusterProfiler")

hub <- AnnotationHub()
query(hub, "Musculus")
Musculus <- hub[["AH57974"]] #query(hub, "org.MM.eg"), AH52234, AH57184
#AH57974 ncbi orgdb

frac_to_numeric <- function(x) sapply(x, function(x) eval(parse(text=x)))

GO_enrichment <- function(component, geneNumber = 250, threshold=0.01, side="N"){
  
  if(side=="N"){
    top_genes <- data.table(as.matrix(results$loadings[[1]][component, ]), keep.rownames = TRUE)[order(V1)][1:geneNumber]$rn
  }else{
    top_genes <- data.table(as.matrix(results$loadings[[1]][component, ]), keep.rownames = TRUE)[order(-V1)][1:geneNumber]$rn
  }

gene_universe <- data.table(as.matrix(results$loadings[[1]][component,]), keep.rownames = TRUE)$rn

ego <- enrichGO(gene = top_genes,
                universe = gene_universe,
                OrgDb = Musculus,
                keyType = 'SYMBOL',
                ont = "BP",
                pAdjustMethod = "BH",
                pvalueCutoff = 1,
                qvalueCutoff = 1)

ego@result$Enrichment <- frac_to_numeric(ego@result$GeneRatio)/frac_to_numeric(ego@result$BgRatio)
ego@result$GeneOdds <- unlist(lapply(strsplit(ego@result$GeneRatio, "/", fixed = TRUE), function(x){ x<-as.numeric(x) ;x[1] / (x[2]-x[1])}))
ego@result$BgOdds <- unlist(lapply(strsplit(ego@result$BgRatio, "/", fixed = TRUE), function(x){ x<-as.numeric(x) ;x[1] / (x[2]-x[1])}))

return(ego@result)

}




GO_data <- list()

for (i in 1:50){
GO_data[[paste0("V",i,"N")]] <- GO_enrichment(i, side="N") 
GO_data[[paste0("V",i,"P")]] <- GO_enrichment(i, side="P")
}

# reduce size taken up
# lapply(names(GO_data), function(x) GO_data[[x]]@geneSets <<- list())

saveRDS(GO_data, "../data/GO_enrichment.rds")

go_volcano_plot <- function(x=GO_data, component="V5N"){
 print(
   ggplot(data.table(x[[component]]), aes(GeneOdds/BgOdds, -log(pvalue), size=Count)) +
     geom_point(aes(colour=p.adjust<0.05)) +
     scale_size_area() +
     geom_label_repel(data = data.table(x[[component]])[order(p.adjust)][1:30][p.adjust<0.7], aes(label = Description, size=0.25), size = 3, force=2) + 
     ggtitle("Volcano plot for Gene Ontology (Biological Processes) enrichment analysis") +
     xlab("Odds Ratio") +
     scale_x_log10(limits=c(1,NA), breaks=c(1,2,3,4,5,6,7,8))
 )
}

go_volcano_plot(component = "V30P")
head(GO_data[["V30P"]][c(2,7,8,10)], 20)


```

